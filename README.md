# Jira Cloud Assets Backup & Restore (formely known as Insight)

## Introduction

Since Jira Assets is integrated with Jira Service Management Premium there has been no way to backup and restore the content of the objectschema's. **Redemption is here!**

The backupAssets.py script will create a set of files which are used by the importAssets.py script. With the config files you can manage which objectschema's need to be in the backup and which need to be restored.

## Prerequisites

These script are created and tested with Python 3.10.2.
Make sure that you install the following modules:
* requests
* python-dateutil

This can be done with `pip install <module name>` or `python -m pip install <module name>`

## Backup
Before you start the first backup make sure you have an account with the propper permissions and an API token (https://id.atlassian.com/manage-profile/security/api-tokens)
Next you need to adjust the file backupAssets-config.json. The template looks like this:
```
{
    "siteName"            : "https://<yoursite>.atlassian.net",
    "username"            : "user@example.com",
    "apiToken"            : "<Atlassian API Token>",
    "objectSchemaKeys"    : [ "<object schema key1>", "<object schema key2>" ]
}
```
As an example you should end up with a content, looking like this:
```
{
    "siteName"            : "https://myorganization.atlassian.net",
    "username"            : "cmdb_admin@myorganization.com",
    "apiToken"            : "fc6903cb80d5d64ca76db81c",
    "objectSchemaKeys"    : [ "FAC", "USERS", "ASSETS"]
}
```

Running the script should be done with: `python backupAssets.py -f backupAssets-config.json`
A backup.log will be generated that will inform you about anything that might go wrong. Since the script will be running in a cron job, the logging will be rotated every day. The number of log files you want to keep can be set in the script with the variable `logFileKeep`.

The backup will be written to a timestamped directory. It will have the following content:
```
2022-06-16_10-41-30\
    config\
        objectschemas.json
    FAC\
    USERS\
    ASSETS\
        config\
            attributes\
                laptops.json
                phones.json
                accesscards.json
                cars.json 
            global_referencetypes.json
            global_statustypes.json
            objectschema.json
            objecttypes.json
            referencetypes.json
            statustypes.json
        objects\
            comments\
                10213.json
                13251.json
            history\
                125661.json
            laptops.json
            phones.json
            accesscards.json
            cars.json 
        objectsmeta\
            laptops.json
            phones.json
            accesscards.json
            cars.json 
```

## Restore
The first thing you need to do when you want to restore a backup, is to edit the importObjectSchema-config.json file. The template looks like this:
```
{
    "siteName"            : "https://myorganization.atlassian.net",
    "username"            : "cmdb_admin@myorganization.com",
    "apiToken"            : "fc6903cb80d5d64ca76db81c",
    "folder"              : "<folder where the backup is stored>",
    "objectSchemas"       : [
        {
            "oldObjectSchemaKey"  : "<object schema key1>",
            "newObjectSchemaKey"  : "<new object schema key1 (may be similar to old)>",
            "newObjectSchemaName" : "<new object schema name1>"
        },
        {
            "oldObjectSchemaKey"  : "<object schema key2>",
            "newObjectSchemaKey"  : "<new object schema key2 (may be similar to old)>",
            "newObjectSchemaName" : "<new object schema name2>"
        }
    ]
}
```
An example of an import config that will import the backed up ASSETS objectschema as ASSETS_IMP:
```
{
    "siteName"            : "https://myorganization.atlassian.net",
    "username"            : "cmdb_admin@myorganization.com",
    "apiToken"            : "fc6903cb80d5d64ca76db81c",
    "folder"              : "2022-06-16_10-41-30,
    "objectSchemas"       : [
        {
            "oldObjectSchemaKey"  : "ASSETS",
            "newObjectSchemaKey"  : "ASSETS_IMP",
            "newObjectSchemaName" : "Assets [Imported]"
        }
    ]
}
```
Importing is done by running the script: `python importAssets.py -f importAssets-config.json`
Logging is done on screen and in the import.log file which is also rotated every day. (See above.)

## Caveats

The fields keys, created, updated and the history of an object are generated by Assets and can not be defined by the script. This means that if you have deleted an object and want to restore it, you can do that with the scripts. But it will get new values for key, created and updated. So after you've restored the lost data, you should iterate over your Jira issues and reattach the restored objects. Next, because the history of an issue can't be recreated, the history from the backup  will be created as a comment.

There is no endpoint (yet) to download & upload avatars and attachments hence they are not backed up.

Within an objectschema there can be references to other objectschema's, so you need make sure you get the order of importing right.
E.g. You have a schema that has all the company assets, maintained by IT and you have a schema that has all the users, maintained by HR.
     Likely that an asset in the it schema has a link to a user. So make sure you import the user schema before the asset schema.
     You can make sure the order is correct in the import JSON file.
     
     
